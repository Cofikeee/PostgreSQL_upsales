WITH
     result_table AS  
    (SELECT mn.name, 
            to_date(u.dt, 'DD.MM.YYYY'),
	    ROW_NUMBER() OVER (PARTITION BY u.manager_id ORDER BY mn.name) AS call_number,
      	    u.result,
       	    LAG(result) OVER (PARTITION BY u.manager_id ORDER BY mn.name) AS previous_result
       FROM upsale AS u 
  	    JOIN managers AS mn ON mn.id = u.manager_id)
        
SELECT name, call_number
  FROM result_table
 WHERE result = 'yes' AND previous_result = 'no'
